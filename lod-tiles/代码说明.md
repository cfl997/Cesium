# LOD 瓦片加载系统代码说明

本文档详细说明 `lod-tiles/index.js` 中各个功能模块的作用和实现原理。

## 📋 文件结构

```
lod-tiles/index.js
├── 导入模块
├── 全局配置
├── LOD 级别配置
├── 工具函数
├── 瓦片加载函数
├── 时间轴控制
└── 事件监听器
```

## 🔧 核心功能模块

### 1. 导入模块（第 1-2 行）

```javascript
import * as Cesium from 'cesium';
import 'cesium/Build/Cesium/Widgets/widgets.css';
```

- **作用**：导入 Cesium 3D 地球引擎库和 UI 组件样式
- **Cesium**：提供 3D 地球渲染、相机控制、实体管理等功能

### 2. 创建 Cesium Viewer（第 8-21 行）

```javascript
const viewer = new Cesium.Viewer('cesiumContainer', {
  terrainProvider: undefined,      // 不使用地形数据
  baseLayerPicker: false,          // 隐藏底图选择器
  geocoder: false,                 // 隐藏地理位置搜索
  homeButton: true,                // 显示主页按钮
  sceneModePicker: false,          // 隐藏场景模式选择器
  navigationHelpButton: false,     // 隐藏导航帮助
  animation: false,                // 隐藏动画控件
  timeline: false,                 // 隐藏时间轴
  fullscreenButton: false,         // 隐藏全屏按钮
  vrButton: false,                 // 隐藏 VR 按钮
  infoBox: false,                  // 隐藏信息框
  selectionIndicator: false,       // 隐藏选择指示器
});
```

- **作用**：创建 Cesium 视图器实例，配置 UI 组件显示/隐藏
- **简洁界面**：隐藏大部分默认 UI，只保留必要的主页按钮

### 3. 数据有效范围（第 26-28 行）

```javascript
const DATA_LAT_MIN = -75;  // 南纬 75° 以北
const DATA_LAT_MAX = 85;   // 北纬 85° 以南
```

- **作用**：定义海洋数据的有效纬度范围
- **原因**：极地区域（南纬 75° 以南、北纬 85° 以北）通常没有海洋数据
- **用途**：在加载瓦片时跳过极地区域，避免无效请求

### 4. 配置参数（第 30-37 行）

```javascript
const config = {
  ncType: 'so',                                    // 数据类型（盐度）
  timeType: 0,                                     // 时间类型
  backendUrl: 'http://localhost:4433/api/tile',   // 后端 API 地址
  depth: 0,                                        // 深度（米）
  level: 0,                                        // 级别
};
```

- **作用**：存储后端 API 请求的默认参数
- **ncType**：NetCDF 数据类型（so = salinity ocean，海洋盐度）
- **可配置**：用户可在界面上修改 backendUrl 和 depth

### 5. 时间轴状态（第 39-42 行）

```javascript
const timelineState = {
  currentTime: '202401',  // 默认时间 YYYYMM 格式
};
```

- **作用**：存储当前选择的时间（年月）
- **格式**：YYYYMM（例如 202401 表示 2024年1月）
- **用途**：用于构建后端 API 请求参数

### 6. 瓦片存储（第 44-45 行）

```javascript
const loadedTiles = new Map();
```

- **作用**：存储已加载的瓦片实体
- **数据结构**：Map，键为 `${level}_${tileX}_${tileY}`，值为瓦片对象
- **用途**：避免重复加载，管理瓦片生命周期

### 7. 性能统计（第 47-53 行）

```javascript
const performanceStats = {
  totalTilesLoaded: 0,    // 累计加载的瓦片数量
  currentLoadTime: 0,     // 当前加载耗时（毫秒）
  lastLoadStart: 0,       // 上次加载开始时间
  isLoading: false,       // 是否正在加载
};
```

- **作用**：统计瓦片加载性能
- **用途**：显示在左侧信息面板，帮助调试和优化

### 8. LOD 级别配置（第 64-73 行）

```javascript
const LOD_LEVELS = [
  { maxHeight: 50000000, level: 0, tilesX: 2, tilesY: 1 },     // Level 0: 2 个瓦片
  { maxHeight: 20000000, level: 1, tilesX: 4, tilesY: 2 },     // Level 1: 8 个瓦片
  { maxHeight: 10000000, level: 2, tilesX: 8, tilesY: 4 },     // Level 2: 32 个瓦片
  { maxHeight: 5000000, level: 3, tilesX: 16, tilesY: 8 },     // Level 3: 128 个瓦片
  { maxHeight: 2000000, level: 4, tilesX: 32, tilesY: 16 },    // Level 4: 512 个瓦片
  { maxHeight: 1000000, level: 5, tilesX: 64, tilesY: 32 },    // Level 5: 2048 个瓦片
  { maxHeight: 500000, level: 6, tilesX: 128, tilesY: 64 },    // Level 6: 8192 个瓦片
  { maxHeight: 0, level: 7, tilesX: 256, tilesY: 128 },        // Level 7: 32768 个瓦片
];
```

- **作用**：定义 8 个 LOD（Level of Detail）级别
- **金字塔结构**：从 Level 0 的 2 个瓦片到 Level 7 的 32768 个瓦片
- **相机高度**：根据相机高度自动选择合适的 LOD 级别
- **瓦片大小**：Level 越高，瓦片越小，细节越丰富

## 🛠️ 核心函数说明

### getCurrentTimeInfo()（第 76-87 行）

**功能**：从时间轴状态获取时间信息

**返回值**：
```javascript
{
  year: 2024,    // 年份
  month: 1,      // 月份
  day: 1,        // 日期（固定为1号）
  hour: 0        // 小时（固定为0点）
}
```

### getLODLevel(cameraHeight)（第 90-97 行）

**功能**：根据相机高度获取对应的 LOD 级别配置

**参数**：
- `cameraHeight`：相机高度（米）

**返回值**：LOD 配置对象

**逻辑**：
1. 遍历 LOD_LEVELS 数组
2. 找到第一个 maxHeight 小于相机高度的级别
3. 如果都不满足，返回最高级别（Level 7）

### lonLatToTile(lon, lat, lodConfig)（第 100-117 行）

**功能**：将经纬度坐标转换为瓦片坐标

**参数**：
- `lon`：经度（-180 到 180）
- `lat`：纬度（-90 到 90）
- `lodConfig`：LOD 级别配置

**返回值**：
```javascript
{
  tileX: 5,      // 瓦片 X 坐标
  tileY: 3,      // 瓦片 Y 坐标
  tilesX: 16,    // X 方向总瓦片数
  tilesY: 8      // Y 方向总瓦片数
}
```

**计算公式**：
- X 坐标：`floor((lon + 180) / 360 * tilesX)`
- Y 坐标：`floor((90 - lat) / 180 * tilesY)`

### tileToLonLatBounds(tileX, tileY, tilesX, tilesY)（第 120-146 行）

**功能**：将瓦片坐标转换为经纬度边界

**参数**：
- `tileX`：瓦片 X 坐标
- `tileY`：瓦片 Y 坐标
- `tilesX`：X 方向总瓦片数
- `tilesY`：Y 方向总瓦片数

**返回值**：
```javascript
{
  west: 120.0,   // 西边界（经度）
  south: 20.0,   // 南边界（纬度）
  east: 125.0,   // 东边界（经度）
  north: 25.0    // 北边界（纬度）
}
```

**特殊处理**：
- 限制在数据有效范围内（南纬 75° 到北纬 85°）
- 如果瓦片完全在有效范围外，返回 null

### buildTileUrl(tileX, tileY, level)（第 149-168 行）

**功能**：构建后端 API 请求 URL

**参数**：
- `tileX`：瓦片 X 坐标
- `tileY`：瓦片 Y 坐标
- `level`：LOD 级别

**返回值**：完整的 API URL

**示例**：
```
http://localhost:4433/api/tile?ncType=so&timeType=0&year=2024&month=1&day=1&hour=0&depth=0&level=2&tileX=5&tileY=3
```

### loadTile(tileX, tileY, level, tilesX, tilesY)（第 171-252 行）

**功能**：加载单个瓦片

**流程**：
1. 检查是否已加载（避免重复）
2. 计算瓦片的经纬度边界
3. 验证边界有效性
4. 构建 API URL
5. 创建 Cesium 矩形实体
6. 将 PNG 图片作为材质贴在地球上
7. 存储到 loadedTiles Map

**关键代码**：
```javascript
const entity = viewer.entities.add({
  name: `Tile_${tileKey}`,
  rectangle: {
    coordinates: Cesium.Rectangle.fromDegrees(west, south, east, north),
    material: new Cesium.ImageMaterialProperty({
      image: url,
      transparent: true,
    }),
    height: 0,  // 贴在地表
  },
});
```

### loadTilesAroundPoint(lon, lat, cameraHeight)（第 255-302 行）

**功能**：加载指定点周围的瓦片（3x3 区域）

**参数**：
- `lon`：中心点经度
- `lat`：中心点纬度
- `cameraHeight`：相机高度

**流程**：
1. 防止重复加载（检查 isLoading 标志）
2. 根据相机高度获取 LOD 级别
3. 计算中心瓦片坐标
4. 加载中心瓦片及周围 3x3 区域（range = 1）
5. 清理旧的不同 LOD 级别的瓦片
6. 更新性能统计

**加载范围**：
```
[dx=-1, dy=-1]  [dx=0, dy=-1]  [dx=1, dy=-1]
[dx=-1, dy=0]   [dx=0, dy=0]   [dx=1, dy=0]   <- 中心瓦片
[dx=-1, dy=1]   [dx=0, dy=1]   [dx=1, dy=1]
```

### cleanupOldTiles(currentLevel)（第 305-316 行）

**功能**：清理旧瓦片

**清理规则**：
1. 移除不同 LOD 级别的瓦片
2. 移除超过 60 秒未访问的瓦片

**作用**：
- 节省内存
- 避免不同 LOD 级别的瓦片重叠显示

### updateStatus(message)（第 319-331 行）

**功能**：更新左侧信息面板的状态显示

**显示内容**：
- 当前时间
- 状态消息
- 已加载瓦片数量
- 加载耗时
- 累计加载数量

## 🎮 事件监听器

### 相机移动结束事件（第 334-349 行）

```javascript
viewer.camera.moveEnd.addEventListener(() => {
  // 节流 300ms
  // 获取相机位置和高度
  // 自动加载当前视野中心的瓦片
});
```

- **触发时机**：相机停止移动时
- **节流**：300ms，避免频繁触发
- **作用**：自动加载新视野的瓦片

### 相机移动中事件（第 352-363 行）

```javascript
viewer.camera.changed.addEventListener(() => {
  // 节流 1s
  // 平滑加载瓦片
});
```

- **触发时机**：相机移动过程中
- **节流**：1秒，避免过于频繁
- **作用**：在移动过程中预加载瓦片

## ⏱️ 时间轴控制

### updateTimeDisplay()（第 382-390 行）

**功能**：更新底部时间轴的时间显示

### previousMonth()（第 407-415 行）

**功能**：切换到上一个月

**流程**：
1. 解析当前时间
2. 月份减 1
3. 更新显示
4. 清除所有瓦片并重新加载

### nextMonth()（第 418-426 行）

**功能**：切换到下一个月

### applyTime()（第 429-450 行）

**功能**：应用用户输入的时间

**验证**：
- 格式必须为 YYYYMM
- 年份范围：1900-2100
- 月份范围：1-12

### clearAllTiles()（第 453-468 行）

**功能**：清除所有已加载的瓦片

**流程**：
1. 遍历 loadedTiles Map
2. 从场景中移除所有实体
3. 清空 Map
4. 100ms 后自动重新加载当前视野的瓦片

## 🚀 初始化流程

1. **创建 Viewer**（第 8 行）
2. **设置初始相机位置**（第 366-368 行）：北京上空 10,000km
3. **延迟 500ms 后初始加载**（第 371-377 行）：加载初始视野的瓦片
4. **绑定时间轴事件**（第 471-480 行）：上月、下月、应用按钮
5. **初始化时间显示**（第 483 行）
6. **输出启动信息**（第 485-486 行）

## 📊 性能优化

1. **节流**：相机事件使用节流，避免频繁触发
2. **去重**：检查 loadedTiles Map，避免重复加载
3. **清理**：定期清理旧瓦片，释放内存
4. **异步加载**：使用 Promise.all 并行加载多个瓦片
5. **范围限制**：只加载 3x3 区域，不加载整个 LOD 级别

## 🔍 调试技巧

1. **控制台日志**：查看瓦片加载信息、LOD 级别、相机位置
2. **状态面板**：实时查看加载状态、瓦片数量、耗时
3. **网络面板**：检查后端 API 请求和响应
4. **Cesium Inspector**：查看实体、材质、坐标系

## 📝 常见问题

### 1. 瓦片不显示？

- 检查后端 API 是否正常返回 PNG 图片
- 检查瓦片边界是否正确
- 检查 CORS 是否配置正确

### 2. 瓦片重叠？

- 检查是否正确清理了旧的 LOD 级别的瓦片
- 检查 cleanupOldTiles 函数是否正常工作

### 3. 性能问题？

- 减小加载范围（range 参数）
- 增加节流时间
- 优化后端 API 响应速度

### 4. 极地区域显示异常？

- 检查 DATA_LAT_MIN 和 DATA_LAT_MAX 配置
- 确保 tileToLonLatBounds 函数正确处理了极地区域
