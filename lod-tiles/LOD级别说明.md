# LOD 级别说明

## 🎯 金字塔结构（从 Level 0 开始）

本系统采用金字塔式的 LOD（Level of Detail）结构，**从 Level 0 开始**。

### 📊 完整级别表

| Level | 瓦片数量 (X×Y) | 总数 | 单个瓦片大小 | 相机高度范围 | 用途 |
|-------|---------------|------|-------------|-------------|------|
| **0** | 2×2 | **4** | 180°×90° | > 50,000 km | 全球视图 |
| **1** | 4×2 | **8** | 90°×90° | 20,000-50,000 km | 半球视图 |
| **2** | 4×4 | **16** | 90°×45° | 10,000-20,000 km | 大陆视图 |
| **3** | 8×4 | **32** | 45°×45° | 5,000-10,000 km | 国家视图 |
| **4** | 8×8 | **64** | 45°×22.5° | 2,000-5,000 km | 区域视图 |
| **5** | 16×8 | **128** | 22.5°×22.5° | 1,000-2,000 km | 省份视图 |
| **6** | 16×16 | **256** | 22.5°×11.25° | 500-1,000 km | 城市视图 |
| **7** | 32×16 | **512** | 11.25°×11.25° | < 500 km | 详细视图 |

## 🌍 Level 0 详解（4 个瓦片）

### 瓦片布局

```
     -180°        0°        180°
  90° ┌───────────┬───────────┐
      │           │           │
      │  (0,0)    │  (1,0)    │
      │           │           │
   0° ├───────────┼───────────┤
      │           │           │
      │  (0,1)    │  (1,1)    │
      │           │           │
 -90° └───────────┴───────────┘
```

### 瓦片覆盖范围

| 瓦片坐标 | 经度范围 | 纬度范围 | 说明 |
|---------|---------|---------|------|
| (0, 0) | -180° to 0° | 0° to 90° | 西半球北部 |
| (1, 0) | 0° to 180° | 0° to 90° | 东半球北部 |
| (0, 1) | -180° to 0° | -90° to 0° | 西半球南部 |
| (1, 1) | 0° to 180° | -90° to 0° | 东半球南部 |

### 特点

- ✅ **最少瓦片数**：只有 4 个瓦片覆盖全球
- ✅ **最大瓦片尺寸**：每个瓦片 180° × 90°
- ✅ **适用场景**：全球视图、卫星视角
- ✅ **加载速度**：最快，只需 4 个请求

## 📈 级别递增规律

### 瓦片数量增长

```
Level 0: 4 tiles    (基础)
Level 1: 8 tiles    (2倍)
Level 2: 16 tiles   (2倍)
Level 3: 32 tiles   (2倍)
Level 4: 64 tiles   (2倍)
Level 5: 128 tiles  (2倍)
Level 6: 256 tiles  (2倍)
Level 7: 512 tiles  (2倍)
```

### 瓦片大小变化

```
Level 0: 180° × 90°
Level 1: 90° × 90°
Level 2: 90° × 45°
Level 3: 45° × 45°
Level 4: 45° × 22.5°
Level 5: 22.5° × 22.5°
Level 6: 22.5° × 11.25°
Level 7: 11.25° × 11.25°
```

## 🎮 使用示例

### 示例 1：查看整个地球

```javascript
相机高度: 50,000 km
自动选择: Level 0
瓦片数量: 4 个
结果: 4 个大瓦片覆盖全球
```

### 示例 2：查看亚洲

```javascript
相机高度: 10,000 km
自动选择: Level 2
瓦片数量: 16 个
结果: 每个瓦片 90° × 45°
```

### 示例 3：查看中国

```javascript
相机高度: 5,000 km
自动选择: Level 3
瓦片数量: 32 个
结果: 每个瓦片 45° × 45°
```

### 示例 4：查看北京

```javascript
相机高度: 500 km
自动选择: Level 6
瓦片数量: 256 个
结果: 每个瓦片 22.5° × 11.25°
```

## 🔄 自动 LOD 切换

系统根据相机高度自动选择最合适的 LOD 级别：

```javascript
if (cameraHeight > 50,000,000m)  → Level 0 (4 tiles)
if (cameraHeight > 20,000,000m)  → Level 1 (8 tiles)
if (cameraHeight > 10,000,000m)  → Level 2 (16 tiles)
if (cameraHeight > 5,000,000m)   → Level 3 (32 tiles)
if (cameraHeight > 2,000,000m)   → Level 4 (64 tiles)
if (cameraHeight > 1,000,000m)   → Level 5 (128 tiles)
if (cameraHeight > 500,000m)     → Level 6 (256 tiles)
else                             → Level 7 (512 tiles)
```

## 🎨 手动设置 Level

在右侧配置面板的 "Level" 输入框中：

```
输入 0 → 强制使用 Level 0（4 个瓦片）
输入 1 → 强制使用 Level 1（8 个瓦片）
输入 2 → 强制使用 Level 2（16 个瓦片）
...
输入 7 → 强制使用 Level 7（512 个瓦片）
```

## 💡 后端实现

### 请求参数

```
GET /api/tile?level=0&tileX=0&tileY=0&...
```

### 根据 Level 确定瓦片总数

```javascript
const LOD_CONFIG = {
  0: { tilesX: 2, tilesY: 2, total: 4 },
  1: { tilesX: 4, tilesY: 2, total: 8 },
  2: { tilesX: 4, tilesY: 4, total: 16 },
  3: { tilesX: 8, tilesY: 4, total: 32 },
  4: { tilesX: 8, tilesY: 8, total: 64 },
  5: { tilesX: 16, tilesY: 8, total: 128 },
  6: { tilesX: 16, tilesY: 16, total: 256 },
  7: { tilesX: 32, tilesY: 16, total: 512 },
};

// 验证瓦片坐标是否有效
function isValidTile(level, tileX, tileY) {
  const config = LOD_CONFIG[level];
  if (!config) return false;
  return tileX >= 0 && tileX < config.tilesX && 
         tileY >= 0 && tileY < config.tilesY;
}
```

### 数据组织建议

```
data/
├── 202401/              # 时间目录
│   ├── level0/          # Level 0: 4 个瓦片
│   │   ├── 0_0.png
│   │   ├── 0_1.png
│   │   ├── 1_0.png
│   │   └── 1_1.png
│   ├── level1/          # Level 1: 8 个瓦片
│   │   ├── 0_0.png
│   │   ├── 0_1.png
│   │   ├── 1_0.png
│   │   ├── 1_1.png
│   │   ├── 2_0.png
│   │   ├── 2_1.png
│   │   ├── 3_0.png
│   │   └── 3_1.png
│   └── ...
└── 202402/
    └── ...
```

## 📊 性能考虑

### 各级别加载策略

| Level | 总瓦片数 | 建议策略 | 说明 |
|-------|---------|---------|------|
| 0 | 4 | 全部加载 | 瓦片少，可一次性加载 |
| 1 | 8 | 全部加载 | 瓦片少，可一次性加载 |
| 2 | 16 | 部分加载 | 加载 3×3 区域 |
| 3 | 32 | 部分加载 | 加载 3×3 区域 |
| 4+ | 64+ | 按需加载 | 只加载可见区域 |

### 内存占用估算

假设每个瓦片 PNG 图片 100KB：

```
Level 0: 4 × 100KB = 400KB
Level 1: 8 × 100KB = 800KB
Level 2: 16 × 100KB = 1.6MB
Level 3: 32 × 100KB = 3.2MB
Level 4: 64 × 100KB = 6.4MB
Level 5: 128 × 100KB = 12.8MB
Level 6: 256 × 100KB = 25.6MB
Level 7: 512 × 100KB = 51.2MB
```

## 🎓 技术要点

### 为什么从 Level 0 开始？

1. **符合编程习惯**：数组索引从 0 开始
2. **与传统系统一致**：Web 地图通常从 Level 0 开始
3. **便于扩展**：可以轻松添加 Level 8, 9, 10...
4. **语义清晰**：Level 0 = 最粗糙，Level 7 = 最详细

### 与 Web Mercator 的区别

**Web Mercator (Google Maps/OSM)**：
```
Level 0: 1 tile (256×256 px)
Level 1: 4 tiles (2×2)
Level 2: 16 tiles (4×4)
Level n: 4^n tiles (2^n × 2^n)
```

**本系统**：
```
Level 0: 4 tiles (2×2)
Level 1: 8 tiles (4×2)
Level 2: 16 tiles (4×4)
Level n: 自定义
```

**优势**：
- ✅ 更灵活的瓦片划分
- ✅ 可以独立调整 X 和 Y 方向
- ✅ 适合科学数据可视化

## 🧪 测试清单

- [ ] Level 0：4 个瓦片正常显示
- [ ] Level 1：8 个瓦片正常显示
- [ ] Level 2-7：各级别正常切换
- [ ] 自动 LOD：相机高度变化时自动切换
- [ ] 手动 LOD：配置面板设置生效
- [ ] 边界瓦片：地球边缘瓦片正确显示
- [ ] 时间切换：更改时间后瓦片更新

## 📚 相关文档

- `使用说明.md` - 完整使用指南
- `LOD金字塔说明.md` - 金字塔结构详解
- `BUG修复说明.md` - 已知问题和修复

---

**版本**: 1.2.0  
**更新日期**: 2024-11-19  
**特性**: 从 Level 0 开始的金字塔结构  
**Level 0**: 4 个瓦片（2×2）
