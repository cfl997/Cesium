# LOD 金字塔瓦片系统说明

## 🏗️ 金字塔结构

本系统采用金字塔式的 LOD（Level of Detail）结构，级别越小，瓦片数量越少，适合远距离观察。

### 瓦片数量分布

| Level | 瓦片数量 (X×Y) | 总数 | 单个瓦片大小 | 相机高度范围 | 用途 |
|-------|---------------|------|-------------|-------------|------|
| **1** | 2×2 | **4** | 180°×90° | > 50,000 km | 全球视图 |
| **2** | 4×2 | **8** | 90°×90° | 20,000-50,000 km | 半球视图 |
| **3** | 4×4 | **16** | 90°×45° | 10,000-20,000 km | 大陆视图 |
| **4** | 8×4 | **32** | 45°×45° | 5,000-10,000 km | 国家视图 |
| **5** | 8×8 | **64** | 45°×22.5° | 2,000-5,000 km | 区域视图 |
| **6** | 16×8 | **128** | 22.5°×22.5° | 1,000-2,000 km | 省份视图 |
| **7** | 16×16 | **256** | 22.5°×11.25° | 500-1,000 km | 城市视图 |
| **8** | 32×16 | **512** | 11.25°×11.25° | < 500 km | 详细视图 |

## 📐 瓦片坐标系统

### 坐标定义
- **X 轴（经度）**：从西向东，0 到 tilesX-1
- **Y 轴（纬度）**：从北向南，0 到 tilesY-1
- **原点**：左上角（西北角）为 (0, 0)

### 计算公式

#### 经纬度 → 瓦片坐标
```javascript
tileSizeX = 360 / tilesX
tileSizeY = 180 / tilesY
tileX = floor((longitude + 180) / tileSizeX)
tileY = floor((90 - latitude) / tileSizeY)
```

#### 瓦片坐标 → 经纬度范围
```javascript
west = tileX * tileSizeX - 180
east = (tileX + 1) * tileSizeX - 180
north = 90 - tileY * tileSizeY
south = 90 - (tileY + 1) * tileSizeY
```

## 🎯 示例说明

### Level 1（4 个瓦片）

```
     -180°        0°        180°
  90° ┌───────────┬───────────┐
      │           │           │
      │  (0,0)    │  (1,0)    │
      │           │           │
   0° ├───────────┼───────────┤
      │           │           │
      │  (0,1)    │  (1,1)    │
      │           │           │
 -90° └───────────┴───────────┘
```

- 瓦片 (0,0): 西半球北部 [-180° to 0°, 0° to 90°]
- 瓦片 (1,0): 东半球北部 [0° to 180°, 0° to 90°]
- 瓦片 (0,1): 西半球南部 [-180° to 0°, -90° to 0°]
- 瓦片 (1,1): 东半球南部 [0° to 180°, -90° to 0°]

### Level 2（8 个瓦片）

```
     -180°   -90°    0°    90°   180°
  90° ┌──────┬──────┬──────┬──────┐
      │(0,0) │(1,0) │(2,0) │(3,0) │
   0° ├──────┼──────┼──────┼──────┤
      │(0,1) │(1,1) │(2,1) │(3,1) │
 -90° └──────┴──────┴──────┴──────┘
```

每个瓦片大小：90° × 90°

### Level 3（16 个瓦片）

```
     -180°   -90°    0°    90°   180°
  90° ┌──────┬──────┬──────┬──────┐
      │(0,0) │(1,0) │(2,0) │(3,0) │
 45°  ├──────┼──────┼──────┼──────┤
      │(0,1) │(1,1) │(2,1) │(3,1) │
  0°  ├──────┼──────┼──────┼──────┤
      │(0,2) │(1,2) │(2,2) │(3,2) │
-45°  ├──────┼──────┼──────┼──────┤
      │(0,3) │(1,3) │(2,3) │(3,3) │
-90°  └──────┴──────┴──────┴──────┘
```

每个瓦片大小：90° × 45°

## 🔄 自动 LOD 切换

系统根据相机高度自动选择合适的 LOD 级别：

### 切换逻辑
```javascript
if (cameraHeight > 50,000,000m)  → Level 1 (4 tiles)
if (cameraHeight > 20,000,000m)  → Level 2 (8 tiles)
if (cameraHeight > 10,000,000m)  → Level 3 (16 tiles)
if (cameraHeight > 5,000,000m)   → Level 4 (32 tiles)
if (cameraHeight > 2,000,000m)   → Level 5 (64 tiles)
if (cameraHeight > 1,000,000m)   → Level 6 (128 tiles)
if (cameraHeight > 500,000m)     → Level 7 (256 tiles)
else                             → Level 8 (512 tiles)
```

### 优势
- ✅ **远距离**：少量大瓦片，减少请求数量
- ✅ **近距离**：大量小瓦片，提供更多细节
- ✅ **平滑过渡**：相机移动时自动切换级别
- ✅ **性能优化**：只加载可见区域的瓦片

## 🌍 实际应用示例

### 场景 1：查看全球
- **相机高度**：50,000 km
- **LOD Level**：1
- **瓦片数量**：4 个
- **每个瓦片**：覆盖半个地球

### 场景 2：查看中国
- **相机高度**：5,000 km
- **LOD Level**：4
- **瓦片数量**：32 个
- **每个瓦片**：45° × 45°（约 5000 km × 5000 km）

### 场景 3：查看北京
- **相机高度**：500 km
- **LOD Level**：7
- **瓦片数量**：256 个
- **每个瓦片**：22.5° × 11.25°（约 2500 km × 1250 km）

## 💡 后端实现建议

### 瓦片生成策略

#### 方案 1：预生成所有瓦片
```
Level 1: 4 tiles
Level 2: 8 tiles
Level 3: 16 tiles
...
Level 8: 512 tiles
总计: 4 + 8 + 16 + 32 + 64 + 128 + 256 + 512 = 1020 tiles
```

#### 方案 2：按需生成
- 根据请求参数动态生成瓦片
- 缓存常用瓦片
- 适合数据量大的场景

### 数据组织

```
data/
├── 202401/           # 时间目录
│   ├── level1/       # LOD 级别
│   │   ├── 0_0.png   # tileX_tileY.png
│   │   ├── 0_1.png
│   │   ├── 1_0.png
│   │   └── 1_1.png
│   ├── level2/
│   │   ├── 0_0.png
│   │   ├── 0_1.png
│   │   └── ...
│   └── ...
└── 202402/
    └── ...
```

## 🔧 配置调整

### 修改 LOD 级别

编辑 `lod-tiles/index.js` 中的 `LOD_LEVELS` 数组：

```javascript
const LOD_LEVELS = [
  { maxHeight: 50000000, level: 1, tilesX: 2, tilesY: 2 },
  { maxHeight: 20000000, level: 2, tilesX: 4, tilesY: 2 },
  // 添加或修改级别...
];
```

### 修改加载范围

```javascript
const range = 1; // 1 = 3x3, 2 = 5x5, 3 = 7x7
```

## 📊 性能考虑

### 瓦片数量与性能

| Level | 总瓦片数 | 3×3 加载 | 5×5 加载 | 建议 |
|-------|---------|---------|---------|------|
| 1 | 4 | 4 | 4 | 全部加载 |
| 2 | 8 | 6-9 | 8 | 全部加载 |
| 3 | 16 | 9 | 16 | 部分加载 |
| 4 | 32 | 9 | 25 | 部分加载 |
| 5+ | 64+ | 9 | 25 | 按需加载 |

### 优化建议

1. **Level 1-2**：可以一次性加载所有瓦片
2. **Level 3-5**：加载 3×3 区域
3. **Level 6-8**：只加载可见区域

## 🎓 技术要点

### 为什么是金字塔结构？

1. **数据量控制**：远距离不需要太多细节
2. **网络优化**：减少不必要的请求
3. **渲染性能**：降低 GPU 负担
4. **用户体验**：快速响应，平滑过渡

### 与传统瓦片系统的区别

**传统系统（如 Web Mercator）**：
- 固定的 2^n × 2^n 结构
- Level 0: 1 tile, Level 1: 4 tiles, Level 2: 16 tiles...

**本系统**：
- 灵活的 X×Y 结构
- 可以根据需求调整每个级别的瓦片数量
- 更适合科学数据可视化

---

**版本**: 1.1.0  
**更新日期**: 2024-11-19  
**特性**: 金字塔式 LOD 瓦片系统
