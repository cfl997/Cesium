# 瓦片坐标诊断指南

## 🎯 Level 1 瓦片布局（4×2 = 8 个瓦片）

### 正确的瓦片布局

```
经度方向：每个瓦片 90°
纬度方向：每个瓦片 90°

     -180°      -90°       0°        90°      180°
  90° ┌─────────┬─────────┬─────────┬─────────┐
      │         │         │         │         │
      │  x0y0   │  x1y0   │  x2y0   │  x3y0   │
      │         │         │         │         │
   0° ├─────────┼─────────┼─────────┼─────────┤
      │         │         │         │         │
      │  x0y1   │  x1y1   │  x2y1   │  x3y1   │
      │         │         │         │         │
 -90° └─────────┴─────────┴─────────┴─────────┘
```

### 每个瓦片的地理范围

| 文件名 | tileX | tileY | 经度范围 | 纬度范围 | 应该显示的内容 |
|--------|-------|-------|---------|---------|--------------|
| x0y0.png | 0 | 0 | -180° to -90° | 0° to 90° | 北美洲西部、阿拉斯加、北太平洋 |
| x1y0.png | 1 | 0 | -90° to 0° | 0° to 90° | 北美洲东部、格陵兰、北大西洋 |
| x2y0.png | 2 | 0 | 0° to 90° | 0° to 90° | 欧洲、非洲北部、俄罗斯西部 |
| x3y0.png | 3 | 0 | 90° to 180° | 0° to 90° | 亚洲东部、中国、日本、俄罗斯东部 |
| x0y1.png | 0 | 1 | -180° to -90° | -90° to 0° | 南太平洋、新西兰西部 |
| x1y1.png | 1 | 1 | -90° to 0° | -90° to 0° | 南美洲、南大西洋 |
| x2y1.png | 2 | 1 | 0° to 90° | -90° to 0° | 非洲南部、印度洋西部 |
| x3y1.png | 3 | 1 | 90° to 180° | -90° to 0° | 澳大利亚、印度洋东部、南太平洋 |

## 🔍 诊断步骤

### 1. 检查瓦片内容

打开浏览器控制台（F12），点击地球上的不同位置，查看加载的瓦片：

```javascript
// 点击北京（116°E, 40°N）
// 应该加载：x3y0.png (tileX=3, tileY=0)

// 点击纽约（-74°W, 40°N）
// 应该加载：x1y0.png (tileX=1, tileY=0)

// 点击悉尼（151°E, -34°S）
// 应该加载：x3y1.png (tileX=3, tileY=1)

// 点击里约热内卢（-43°W, -23°S）
// 应该加载：x1y1.png (tileX=1, tileY=1)
```

### 2. 验证坐标计算

在控制台输入以下代码验证：

```javascript
// Level 1: tilesX=4, tilesY=2
const tileSizeX = 360 / 4;  // 90°
const tileSizeY = 180 / 2;  // 90°

// 测试北京 (116°E, 40°N)
const lon = 116;
const lat = 40;
const tileX = Math.floor((lon + 180) / tileSizeX);  // (116+180)/90 = 3.28 → 3
const tileY = Math.floor((90 - lat) / tileSizeY);   // (90-40)/90 = 0.55 → 0
console.log(`北京应该在: x${tileX}y${tileY}.png`);  // x3y0.png

// 测试纽约 (-74°W, 40°N)
const lon2 = -74;
const lat2 = 40;
const tileX2 = Math.floor((lon2 + 180) / tileSizeX);  // (-74+180)/90 = 1.17 → 1
const tileY2 = Math.floor((90 - lat2) / tileSizeY);   // (90-40)/90 = 0.55 → 0
console.log(`纽约应该在: x${tileX2}y${tileY2}.png`);  // x1y0.png
```

### 3. 检查后端数据

您的后端数据可能使用了不同的坐标系统。常见的问题：

#### 问题 1：Y 轴方向相反

**症状**：南半球的数据显示在北半球

**原因**：有些系统 Y 轴从南向北（0 = 南极，1 = 北极）

**解决方案**：在后端翻转 Y 坐标
```javascript
// 前端请求：tileY=0（北半球）
// 后端应该读取：tileY=0（北半球）

// 如果您的数据 Y 轴相反：
const actualTileY = (tilesY - 1) - tileY;
// Level 1: tilesY=2
// 前端 tileY=0 → 后端读取 (2-1)-0 = 1
// 前端 tileY=1 → 后端读取 (2-1)-1 = 0
```

#### 问题 2：经度范围不同

**症状**：东西半球数据位置错误

**原因**：有些系统使用 [0°, 360°] 而不是 [-180°, 180°]

**解决方案**：转换经度范围
```javascript
// 前端使用：-180° to 180°
// 如果后端使用：0° to 360°

// 转换公式：
west_360 = (west_180 + 360) % 360;
east_360 = (east_180 + 360) % 360;
```

#### 问题 3：瓦片索引起始不同

**症状**：所有瓦片位置都偏移

**原因**：后端从 1 开始索引而不是从 0

**解决方案**：调整索引
```javascript
// 前端：tileX=0, tileY=0
// 后端文件：x1y1.png（从 1 开始）

// 在后端添加偏移：
const fileX = tileX + 1;
const fileY = tileY + 1;
```

## 🔧 快速修复方案

### 方案 1：在前端翻转 Y 坐标

如果确认是 Y 轴相反的问题，修改 `lonLatToTile` 函数：

```javascript
function lonLatToTile(lon, lat, lodConfig) {
  const { tilesX, tilesY } = lodConfig;
  const tileSizeX = 360 / tilesX;
  const tileSizeY = 180 / tilesY;
  
  const tileX = Math.floor((lon + 180) / tileSizeX);
  let tileY = Math.floor((90 - lat) / tileSizeY);
  
  // 如果后端 Y 轴相反，取消下面的注释
  // tileY = (tilesY - 1) - tileY;
  
  return { tileX, tileY, tileSizeX, tileSizeY };
}
```

### 方案 2：在后端调整坐标

修改后端代码，在读取文件前转换坐标：

```javascript
// 接收前端参数
let { tileX, tileY, level } = req.query;

// 如果数据 Y 轴相反
const config = LOD_CONFIG[level];
const actualTileY = (config.tilesY - 1) - parseInt(tileY);

// 读取文件
const filename = `x${tileX}y${actualTileY}.png`;
```

## 📊 测试用例

### Level 1 测试点

| 位置 | 经纬度 | 应该加载 | 应该看到 |
|------|--------|---------|---------|
| 阿拉斯加 | -150°, 60° | x0y0.png | 北美西北部 |
| 纽约 | -74°, 40° | x1y0.png | 北美东部 |
| 伦敦 | 0°, 51° | x2y0.png | 欧洲 |
| 北京 | 116°, 40° | x3y0.png | 中国 |
| 智利 | -70°, -30° | x1y1.png | 南美洲 |
| 南非 | 25°, -30° | x2y1.png | 非洲南部 |
| 悉尼 | 151°, -34° | x3y1.png | 澳大利亚 |

## 🎨 可视化调试

在浏览器控制台运行：

```javascript
// 显示所有 Level 1 瓦片的边界
const level1 = { tilesX: 4, tilesY: 2 };
const tileSizeX = 360 / level1.tilesX;  // 90°
const tileSizeY = 180 / level1.tilesY;  // 90°

for (let y = 0; y < level1.tilesY; y++) {
  for (let x = 0; x < level1.tilesX; x++) {
    const west = x * tileSizeX - 180;
    const east = (x + 1) * tileSizeX - 180;
    const north = 90 - y * tileSizeY;
    const south = 90 - (y + 1) * tileSizeY;
    
    console.log(`x${x}y${y}: [${west}°, ${south}°] to [${east}°, ${north}°]`);
    
    // 在地球上绘制边界框
    viewer.entities.add({
      name: `Tile_x${x}y${y}`,
      rectangle: {
        coordinates: Cesium.Rectangle.fromDegrees(west, south, east, north),
        material: Cesium.Color.RED.withAlpha(0.3),
        outline: true,
        outlineColor: Cesium.Color.RED,
        outlineWidth: 2,
      },
    });
  }
}
```

## 💡 建议

1. **先验证 Level 0**：Level 0 只有 4 个瓦片，更容易诊断
2. **检查数据源**：确认您的 NetCDF 或原始数据的坐标系统
3. **逐个测试**：点击已知位置，验证加载的瓦片是否正确
4. **对比参考**：使用 Google Maps 或其他地图对比位置

## 📞 需要帮助？

如果问题仍然存在，请提供：
1. 点击某个已知位置（如北京）时加载的瓦片文件名
2. 该瓦片实际显示的内容（截图）
3. 后端数据的坐标系统说明

---

**提示**：最常见的问题是 Y 轴方向相反！
