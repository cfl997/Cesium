# LOD 瓦片加载系统 - 使用说明

## 🚀 快速开始

### 1. 启动项目
```bash
npm run start:lod
```
项目将在 `http://localhost:3001` 启动

### 2. 界面说明

#### 左侧信息面板
- 显示系统状态
- 显示加载进度
- 显示已加载瓦片数量

#### 右侧配置面板
- **后端地址**：默认 `http://localhost:4433/api/tile`
- **深度 (depth)**：默认 0，可调整
- **Level**：默认 0，可调整

#### 底部时间轴面板
- **年月输入框**：输入 YYYYMM 格式（如 202401）
- **上月按钮**：切换到上一个月
- **下月按钮**：切换到下一个月
- **应用按钮**：应用当前时间设置
- **时间显示**：显示当前选择的时间

## 📋 操作流程

### 基本操作
1. **设置时间**
   - 在时间轴输入框中输入 `202401`（或其他年月）
   - 点击"应用"按钮
   - 或使用"上月""下月"按钮切换

2. **点击地球加载瓦片**
   - 点击地球表面任意位置
   - 系统会自动：
     - 计算点击位置的经纬度
     - 根据相机高度确定 LOD 级别
     - 计算瓦片坐标
     - 向后端请求对应的 PNG 图片
     - 将图片贴在地球表面

3. **查看效果**
   - 瓦片会自动贴在地球表面
   - 左侧面板显示加载状态
   - 可以拖拽旋转视角查看

### 高级操作

#### 调整 LOD 级别
系统会根据相机高度自动选择 LOD 级别：
- 距离越远，瓦片越大（Level 0）
- 距离越近，瓦片越小（Level 4）

手动调整：
1. 在右侧配置面板修改 Level 值
2. 重新点击地球加载瓦片

#### 更改时间
1. 修改时间轴的年月值
2. 点击"应用"按钮
3. 系统会清除旧瓦片
4. 重新点击地球加载新时间的瓦片

#### 配置后端地址
如果后端运行在不同的地址或端口：
1. 在右侧配置面板修改后端地址
2. 格式：`http://host:port/api/tile`
3. 重新点击地球加载瓦片

## 🔧 后端 API 说明

### 请求格式
```
GET http://localhost:4433/api/tile
```

### 请求参数
| 参数 | 类型 | 示例 | 说明 |
|------|------|------|------|
| ncType | string | "so" | 数据类型（固定为 "so"） |
| timeType | int | 0 | 时间类型（固定为 0） |
| year | int | 2024 | 年份（从时间轴获取） |
| month | int | 1 | 月份（从时间轴获取） |
| day | int | 1 | 日期（固定为 1） |
| hour | int | 0 | 小时（固定为 0） |
| depth | double | 0.0 | 深度（可配置） |
| level | int | 2 | LOD 级别（自动计算或手动配置） |
| tileX | int | 5 | 瓦片 X 坐标（自动计算） |
| tileY | int | 3 | 瓦片 Y 坐标（自动计算） |

### 响应格式
- 返回 PNG 图片
- Content-Type: `image/png`
- 建议使用透明背景

### 示例请求
```
http://localhost:4433/api/tile?ncType=so&timeType=0&year=2024&month=1&day=1&hour=0&depth=0&level=2&tileX=5&tileY=3
```

## 🎯 LOD 级别说明

| Level | 相机高度范围 | 瓦片大小 | 用途 |
|-------|-------------|---------|------|
| 0 | > 1,000,000m | 45° | 全球视图 |
| 1 | 500,000 - 1,000,000m | 22.5° | 大陆视图 |
| 2 | 100,000 - 500,000m | 11.25° | 国家视图 |
| 3 | 50,000 - 100,000m | 5.625° | 省份视图 |
| 4 | < 50,000m | 2.8125° | 城市视图 |

## 📐 瓦片坐标系统

### 坐标计算
- 经度范围：-180° 到 180°
- 纬度范围：-90° 到 90°
- 瓦片从左上角 (0, 0) 开始编号

### 计算公式
```javascript
tileX = floor((longitude + 180) / tileSize)
tileY = floor((90 - latitude) / tileSize)
```

### 示例
假设 Level 2（瓦片大小 11.25°）：
- 点击位置：经度 116.4°，纬度 39.9°
- tileX = floor((116.4 + 180) / 11.25) = 26
- tileY = floor((90 - 39.9) / 11.25) = 4

## ⚠️ 注意事项

1. **后端必须启动**
   - 确保后端服务运行在 `http://localhost:4433`
   - 后端必须支持 CORS

2. **时间格式**
   - 必须是 6 位数字
   - 格式：YYYYMM
   - 示例：202401（2024年1月）

3. **瓦片清理**
   - 更改时间后会自动清除旧瓦片
   - 切换 LOD 级别会清理不同级别的瓦片

4. **性能优化**
   - 每次点击加载 3x3 = 9 个瓦片
   - 可以修改代码中的 `range` 变量调整加载范围

## 🐛 常见问题

### Q: 点击地球没有反应？
A: 检查：
- 后端是否启动
- 浏览器控制台是否有错误
- 后端地址是否正确

### Q: 图片无法显示？
A: 检查：
- 后端是否返回了正确的 PNG 图片
- 图片 URL 是否可以直接访问
- 浏览器控制台的网络请求

### Q: 如何修改加载范围？
A: 编辑 `lod-tiles/index.js`：
```javascript
const range = 1; // 改为 2 可以加载 5x5 区域
```

### Q: 如何禁用自动 LOD？
A: 在右侧配置面板手动设置 Level 值，系统会使用该值而不是自动计算

## 📞 技术支持

如有问题，请检查：
1. 浏览器控制台（F12）的错误信息
2. 网络请求是否成功
3. 后端日志

---

**版本**: 1.0  
**更新日期**: 2024-11-19
