# 更新日志 - 金字塔 LOD 结构

## 📅 版本 1.1.0 - 2024-11-19

### 🎉 重大更新：金字塔式 LOD 系统

将原有的固定瓦片大小系统改为金字塔式瓦片数量系统。

---

## 🔄 主要变更

### 1. LOD 级别重新定义

#### 旧系统（基于瓦片大小）
```javascript
Level 0: tileSize = 45°    (8×4 = 32 tiles)
Level 1: tileSize = 22.5°  (16×8 = 128 tiles)
Level 2: tileSize = 11.25° (32×16 = 512 tiles)
...
```

#### 新系统（金字塔结构）
```javascript
Level 1: 2×2 = 4 tiles     (最少，最粗糙)
Level 2: 4×2 = 8 tiles
Level 3: 4×4 = 16 tiles
Level 4: 8×4 = 32 tiles
Level 5: 8×8 = 64 tiles
Level 6: 16×8 = 128 tiles
Level 7: 16×16 = 256 tiles
Level 8: 32×16 = 512 tiles (最多，最详细)
```

### 2. 核心概念变化

| 项目 | 旧系统 | 新系统 |
|------|--------|--------|
| **级别定义** | 基于瓦片大小 | 基于瓦片数量 |
| **Level 含义** | 越大越详细 | 越大越详细 |
| **最小级别** | Level 0 | Level 1 |
| **瓦片数量** | 不固定 | 明确定义 |
| **瓦片大小** | 固定 | 动态计算 |

---

## 📊 详细对比

### Level 1（最粗糙）

**瓦片布局：**
```
2×2 = 4 个瓦片
每个瓦片：180° × 90°
```

**用途：** 全球视图，相机高度 > 50,000 km

**示例：**
- 瓦片 (0,0): 西半球北部
- 瓦片 (1,0): 东半球北部
- 瓦片 (0,1): 西半球南部
- 瓦片 (1,1): 东半球南部

### Level 2

**瓦片布局：**
```
4×2 = 8 个瓦片
每个瓦片：90° × 90°
```

**用途：** 半球视图，相机高度 20,000-50,000 km

### Level 8（最详细）

**瓦片布局：**
```
32×16 = 512 个瓦片
每个瓦片：11.25° × 11.25°
```

**用途：** 详细视图，相机高度 < 500 km

---

## 🔧 代码变更

### 1. LOD_LEVELS 配置

**变更前：**
```javascript
const LOD_LEVELS = [
  { maxHeight: 1000000, level: 0, tileSize: 45 },
  { maxHeight: 500000, level: 1, tileSize: 22.5 },
  // ...
];
```

**变更后：**
```javascript
const LOD_LEVELS = [
  { maxHeight: 50000000, level: 1, tilesX: 2, tilesY: 2 },
  { maxHeight: 20000000, level: 2, tilesX: 4, tilesY: 2 },
  { maxHeight: 10000000, level: 3, tilesX: 4, tilesY: 4 },
  // ...
];
```

### 2. lonLatToTile 函数

**变更前：**
```javascript
function lonLatToTile(lon, lat, level) {
  const tileSize = LOD_LEVELS.find(l => l.level === level)?.tileSize || 45;
  const tileX = Math.floor((lon + 180) / tileSize);
  const tileY = Math.floor((90 - lat) / tileSize);
  return { tileX, tileY, tileSize };
}
```

**变更后：**
```javascript
function lonLatToTile(lon, lat, lodConfig) {
  const { tilesX, tilesY } = lodConfig;
  const tileSizeX = 360 / tilesX;
  const tileSizeY = 180 / tilesY;
  
  const tileX = Math.floor((lon + 180) / tileSizeX);
  const tileY = Math.floor((90 - lat) / tileSizeY);
  
  return { tileX, tileY, tileSizeX, tileSizeY };
}
```

### 3. tileToLonLatBounds 函数

**变更前：**
```javascript
function tileToLonLatBounds(tileX, tileY, tileSize) {
  // 使用单一的 tileSize
}
```

**变更后：**
```javascript
function tileToLonLatBounds(tileX, tileY, tileSizeX, tileSizeY) {
  // 使用 tileSizeX 和 tileSizeY
}
```

### 4. loadTile 函数

**函数签名变更：**
```javascript
// 旧: loadTile(tileX, tileY, level, tileSize)
// 新: loadTile(tileX, tileY, level, tileSizeX, tileSizeY)
```

### 5. loadTilesAroundPoint 函数

**主要变更：**
- 使用 `tilesX` 和 `tilesY` 代替计算最大瓦片数
- 添加控制台日志显示 LOD 信息
- 传递 `lodConfig` 对象而不是 `level`

---

## 🎯 优势

### 1. 更清晰的层级结构
- ✅ Level 1 = 4 tiles（一目了然）
- ✅ Level 2 = 8 tiles
- ✅ 瓦片数量明确定义

### 2. 更灵活的配置
- ✅ 可以独立调整 X 和 Y 方向的瓦片数
- ✅ 适应不同的数据分布
- ✅ 支持非正方形瓦片

### 3. 更好的性能控制
- ✅ 远距离：少量瓦片，快速加载
- ✅ 近距离：大量瓦片，丰富细节
- ✅ 渐进式加载，平滑过渡

### 4. 符合直觉
- ✅ Level 1 = 最少瓦片 = 最粗糙
- ✅ Level 8 = 最多瓦片 = 最详细
- ✅ 与传统金字塔概念一致

---

## 📝 使用说明

### 查看当前 LOD 信息

打开浏览器控制台（F12），点击地球时会看到：

```
LOD Level 3: 4x4 = 16 个瓦片
中心瓦片: (2, 1), 瓦片大小: 90.00° x 45.00°
```

### 手动设置 LOD 级别

在右侧配置面板的 "Level" 输入框中输入 1-8：
- 输入 1：强制使用 Level 1（4 个瓦片）
- 输入 8：强制使用 Level 8（512 个瓦片）

### 后端适配

后端收到的参数：
```
level=3&tileX=2&tileY=1
```

根据 level 确定瓦片总数：
```javascript
const LOD_CONFIG = {
  1: { tilesX: 2, tilesY: 2, total: 4 },
  2: { tilesX: 4, tilesY: 2, total: 8 },
  3: { tilesX: 4, tilesY: 4, total: 16 },
  // ...
};
```

---

## 🧪 测试建议

### 1. 测试不同 LOD 级别

```javascript
// 在配置面板设置不同的 Level 值
Level 1 → 应该看到 4 个大瓦片
Level 2 → 应该看到 8 个瓦片
Level 3 → 应该看到 16 个瓦片
```

### 2. 测试自动切换

```javascript
// 调整相机高度
高度 > 50,000 km → Level 1 (4 tiles)
高度 5,000 km → Level 4 (32 tiles)
高度 500 km → Level 7 (256 tiles)
```

### 3. 测试边界情况

```javascript
// 点击地球边缘
点击 180° 经线附近
点击 90° 纬线附近
点击 -180° 经线附近
```

---

## 🐛 已知问题

### 无

当前版本已修复所有已知问题。

---

## 📚 相关文档

- `LOD金字塔说明.md` - 详细的金字塔结构说明
- `使用说明.md` - 完整使用指南
- `BUG修复说明.md` - 边界问题修复说明

---

## 🔜 未来计划

1. **动态 LOD 调整**
   - 根据网络速度自动调整
   - 根据设备性能优化

2. **瓦片预加载**
   - 预测用户移动方向
   - 提前加载周围瓦片

3. **缓存机制**
   - 本地缓存已加载瓦片
   - 减少重复请求

4. **更多 LOD 级别**
   - 支持 Level 9, 10...
   - 更精细的细节层次

---

## ✅ 迁移检查清单

如果您之前使用了旧版本，请检查：

- [ ] 后端是否支持新的 LOD 级别（1-8）
- [ ] 瓦片数据是否按新结构组织
- [ ] 测试所有 LOD 级别是否正常工作
- [ ] 检查边界瓦片是否正确显示
- [ ] 验证自动 LOD 切换是否平滑

---

**版本**: 1.1.0  
**发布日期**: 2024-11-19  
**重大变更**: 金字塔式 LOD 系统  
**向后兼容**: 否（需要更新后端）
